
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ãã‚ã°ã‚“ èª­ã¿ä¸Šã’ç®—ãƒ»å¾©ç¿’ãƒ„ãƒ¼ãƒ«</title>
<style>
  :root { --bg:#0f172a; --panel:#111827; --text:#e5e7eb; --muted:#94a3b8; --line:#334155; }
  *{ box-sizing:border-box; }
  body{
    background:var(--bg); color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif;
    margin:0;
  }
  header, footer{ padding:16px 20px; }
  h1{ margin:0 0 10px; font-size:1.3rem; }
  p.note{ color:var(--muted); margin:6px 0 0; }

  #controls{ background:var(--panel); padding:16px 20px; }

  .row{
    display:flex; gap:8px; margin:8px 0; flex-wrap:wrap; align-items:center;
  }
  .grid{
    display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px;
  }
  input[type="number"], select{
    padding:8px; border-radius:6px; border:1px solid var(--line);
    background:#0b1220; color:var(--text);
  }
  input[type="file"]{ color:var(--text); }

  button{
    padding:8px 12px; border:none; border-radius:8px;
    background:#1f2937; color:var(--text); cursor:pointer;
  }
  button:hover{ background:#374151; }
  button:disabled{ opacity:0.5; cursor:not-allowed; }

  #logArea{
    background:#0b1220; border:1px solid var(--line); border-radius:8px;
    padding:12px; min-height:200px; white-space:pre-wrap; overflow:auto;
  }

  /* ç­”ãˆè¡¨ç¤ºãƒœãƒƒã‚¯ã‚¹ï¼ˆåˆæœŸéè¡¨ç¤ºï¼‰ */
  #answerContainer {
    display:none;
    background:#0b1220; border:1px solid var(--line); border-radius:8px;
    padding:12px; margin-top:10px;
  }
</style>
</head>

<body>
<header>
  <h1>ãã‚ã°ã‚“ èª­ã¿ä¸Šã’ç®—ãƒ»å¾©ç¿’ãƒ„ãƒ¼ãƒ«</h1>
  <p class="note">
    â€» å…ƒã‚¢ãƒ—ãƒªã® CSVï¼ˆé–‹å§‹æ™‚CSVï¼è¨˜éŒ²ç”¨CSVï¼‰ã‚’èª­ã¿è¾¼ã‚“ã§å¾©ç¿’ã—ã¾ã™ã€‚<br>
    â€» ã“ã®ç”»é¢ã§ä½œå•ã¯è¡Œã„ã¾ã›ã‚“ã€‚
  </p>
</header>

<section id="controls">

  <!-- éŸ³å£°åˆæœŸåŒ– -->
  <div class="row">
    <button id="initVoiceBtn">ğŸ›ï¸ éŸ³å£°ã‚’åˆæœŸåŒ–</button>
    <button id="testSpeakBtn" disabled>ğŸ¤ ãƒ†ã‚¹ãƒˆç™ºè©±</button>
  </div>

  <!-- CSV èª­ã¿è¾¼ã¿ -->
  <div class="row">
    <input type="file" id="csvInput" accept=".csv" />
    <button id="loadCsvBtn">CSV èª­ã¿è¾¼ã¿</button>
    <button id="toggleAnswerBtn" disabled>ğŸ”½ ç­”ãˆã‚’è¡¨ç¤º</button>
  </div>

  <!-- è¨­å®š -->
  <fieldset>
    <legend>è¨­å®šï¼ˆCSV èª­ã¿è¾¼ã¿å¾Œã«è‡ªå‹•å…¥åŠ›ï¼æ‰‹å‹•ä¸Šæ›¸ãå¯ï¼‰</legend>
    <div class="grid">
      <label>æ¡æ•°ï¼š <input type="number" id="digits" min="1" max="16" /> </label>
      <label>å£æ•°ï¼ˆ1å•ã‚ãŸã‚Šï¼‰ï¼š <input type="number" id="kousu" min="1" max="50" /> </label>
      <label>å•é¡Œæ•°ï¼š <input type="number" id="problemCount" min="1" max="50" /> </label>
      <label>ãƒ¢ãƒ¼ãƒ‰ï¼š
        <select id="mode">
          <option value="plus">è¶³ã—ç®—ã®ã¿</option>
          <option value="mix">å¼•ãç®—ã‚’æ··ãœã‚‹</option>
        </select>
      </label>
      <label>é€Ÿåº¦ï¼š <input type="number" id="rate" min="0.5" max="10" step="0.1" /> </label>
      <label>ãƒ”ãƒƒãƒï¼š <input type="number" id="pitch" min="0.5" max="2" step="0.05" /> </label>
      <label>å£é–“éš”ï¼ˆç§’ï¼‰ï¼š <input type="number" id="stepInterval" min="0.1" max="2" step="0.1" /> </label>
      <label>å•é¡Œé–“éš”ï¼ˆç§’ï¼‰ï¼š <input type="number" id="problemInterval" min="1" max="60" step="1" /> </label>
      <label>æ¼¢æ•°å­—èª­ã¿ï¼š
        <select id="useKanji">
          <option value="false">ä½¿ã‚ãªã„</option>
          <option value="true">ä½¿ã†</option>
        </select>
      </label>
    </div>
  </fieldset>

  <!-- æ“ä½œãƒœã‚¿ãƒ³ -->
  <div class="row">
    <button id="startBtn" disabled>â–¶ é€šã—ã§èª­ã¿ä¸Šã’</button>
    <button id="singleBtn" disabled>ğŸ”Š æŒ‡å®šå•é¡Œã®ã¿</button>
    <input type="number" id="singleIndex" placeholder="ç•ªå·" min="1" style="width:90px" />
  </div>
</section>

<!-- ãƒ­ã‚° -->
<section style="padding:16px 20px;">
  <h2>ãƒ­ã‚°</h2>
  <pre id="logArea"></pre>

  <!-- ç­”ãˆï¼ˆåˆæœŸéè¡¨ç¤ºï¼‰ -->
  <div id="answerContainer">
    <h3>ç­”ãˆä¸€è¦§</h3>
    <div id="answerList" style="padding-left:1rem; line-height:1.8;"></div>
  </div>
</section>

<footer>
  <small class="note">
    èª­ã¿ä¸Šã’ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã® Web Speech API ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚<br>
    iOS ã¯ã‚µã‚¤ãƒ¬ãƒ³ãƒˆã‚¹ã‚¤ãƒƒãƒã‚’ OFF ã«ã—ã¦ãã ã•ã„ã€‚
  </small>
</footer>

<script>
/************************************************************
 *  çŠ¶æ…‹
 ************************************************************/
let voices = [];
let selectedVoice = null;
let problems = [];       // [{index, steps:[{op,value}], result}]
let baseSettings = null; // CSVã‹ã‚‰èª­ã‚“ã è¨­å®šã®ãƒ™ãƒ¼ã‚¹

/************************************************************
 *  åˆæœŸå€¤ï¼ˆç©ºæ¬„è£œæ­£ï¼‰
 ************************************************************/
document.addEventListener('DOMContentLoaded', () => {
  if (!rate.value) rate.value = "1.0";
  if (!pitch.value) pitch.value = "1.0";
  if (!stepInterval.value) stepInterval.value = "0.7";
  if (!problemInterval.value) problemInterval.value = "10";
});

/************************************************************
 *  éŸ³å£°ã¾ã‚ã‚Š
 ************************************************************/
function populateVoices(){
  voices = speechSynthesis.getVoices();
  const ja = voices.find(v => v.lang && v.lang.startsWith("ja"));
  selectedVoice = ja ?? voices[0] ?? null;
}
speechSynthesis.onvoiceschanged = populateVoices;

async function ensureVoices(timeoutMs = 2500) {
  populateVoices();
  if (voices.length) return true;

  return await new Promise(resolve => {
    const start = performance.now();
    const cleanup = () => speechSynthesis.onvoiceschanged = null;
    speechSynthesis.onvoiceschanged = () => { populateVoices(); cleanup(); resolve(true); };

    (function tick(){
      if (voices.length){ cleanup(); resolve(true); return; }
      if (performance.now() - start > timeoutMs){ cleanup(); resolve(false); return; }
      setTimeout(tick, 100);
    })();
  });
}

function delay(ms){ return new Promise(r=>setTimeout(r,ms)); }

function speak(text){
  return new Promise(resolve=>{
    const u = new SpeechSynthesisUtterance(text);
    if (selectedVoice) u.voice = selectedVoice;
    u.rate = parseFloat(rate.value) || 1.0;
    u.pitch = parseFloat(pitch.value) || 1.0;
    u.lang = selectedVoice?.lang ?? "ja-JP";
    u.onend = resolve;
    u.onerror = resolve;
    try{ speechSynthesis.speak(u);}catch{ resolve(); }
  });
}

initVoiceBtn.onclick = async () => {
  try{ speechSynthesis.cancel(); }catch{}
  const ok = await ensureVoices(3000);
  if (!ok) try{ await speak("ãƒ†ã‚¹ãƒˆ"); }catch{}
  try{ await speak("éŸ³å£°åˆæœŸåŒ–ãŒå®Œäº†ã—ã¾ã—ãŸã€‚"); }catch{}
  testSpeakBtn.disabled = false;
  log("éŸ³å£°åˆæœŸåŒ–å®Œäº†");
};

testSpeakBtn.onclick = () => speak("ãƒ†ã‚¹ãƒˆç™ºè©±ã§ã™ã€‚");

/************************************************************
 *  ãƒ­ã‚°
 ************************************************************/
function log(t){
  logArea.textContent += t + "\n";
  logArea.scrollTop = logArea.scrollHeight;
}

/************************************************************
 *  CSVèª­ã¿è¾¼ã¿ï¼ˆé–‹å§‹æ™‚CSVï¼è¨˜éŒ²CSVã®ä¸¡æ–¹å¯¾å¿œï¼‰
 ************************************************************/
loadCsvBtn.onclick = async () => {
  const file = csvInput.files?.[0];
  if (!file){ alert("CSV ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
  parseCsv(await file.text());
};

function splitCsvLine(line){
  return line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(s=>s.replace(/^"|"$/g,""));
}

function parseCsv(text){
  const lines = text.split(/\r?\n/).filter(l=>l.trim());
  const header = splitCsvLine(lines[0]);
  const rows = lines.slice(1).map(splitCsvLine);

  function h(name){
    return header.findIndex(x=>x.toLowerCase()===name.toLowerCase());
  }

  const idxSteps = h("steps");
  const idxPIndex = h("problemindex");
  const idxAnswer = h("answer");

  if (idxSteps<0 || idxPIndex<0 || idxAnswer<0){
    alert("å¿…è¦åˆ—ï¼ˆProblemIndex / Steps / Answerï¼‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
    return;
  }

  // è¨­å®šç³»
  const idxDigits = h("digits");
  const idxKousu = h("kousu");
  const idxPcount = h("problemcount");
  const idxMode = h("mode");
  const idxRate = h("rate");
  const idxStep = h("stepinterval");
  const idxPinterval = h("probleminterval");
  const idxUseKanji = h("usekanji");

  problems = [];
  let base = null;

  rows.forEach(r=>{
    if (!base){
      base = {
        digits: idxDigits>=0 ? parseInt(r[idxDigits]) : 6,
        kousu: idxKousu>=0 ? parseInt(r[idxKousu]) : 10,
        problemCount: idxPcount>=0 ? parseInt(r[idxPcount]) : rows.length,
        mode: idxMode>=0 ? r[idxMode] : "plus",
        rate: idxRate>=0 ? parseFloat(r[idxRate]) : 1.0,
        stepInterval: idxStep>=0 ? parseFloat(r[idxStep]) : 0.7,
        problemInterval: idxPinterval>=0 ? parseFloat(r[idxPinterval]) : 10,
        useKanji: idxUseKanji>=0 ? (r[idxUseKanji]==="true") : false
      };
    }

    const steps = r[idxSteps].split(',').map(s=>{
      const op = s[0];
      const val = parseInt(s.slice(1),10);
      return {op,value:val};
    });

    problems.push({
      index: parseInt(r[idxPIndex]),
      steps,
      result: parseInt(r[idxAnswer])
    });
  });

  // UI ã«åæ˜ 
  digits.value = base.digits;
  kousu.value = base.kousu;
  problemCount.value = base.problemCount;
  mode.value = base.mode;
  rate.value = base.rate;
  pitch.value = pitch.value || "1.0";
  stepInterval.value = base.stepInterval;
  problemInterval.value = base.problemInterval;
  useKanji.value = base.useKanji ? "true":"false";

  startBtn.disabled = false;
  singleBtn.disabled = false;
  toggleAnswerBtn.disabled = false;

  // ç­”ãˆä¸€è¦§ã‚’ç”Ÿæˆï¼ˆåˆæœŸã¯éè¡¨ç¤ºï¼‰
  renderAnswers();

  log(`CSV ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚å•é¡Œæ•°ï¼š${problems.length}`);
}

/************************************************************
 *  ç­”ãˆä¸€è¦§ï¼ˆè¡¨ç¤º/éè¡¨ç¤ºï¼‰
 ************************************************************/
function renderAnswers(){
  answerList.innerHTML = "";
  for (const p of problems){
    const div = document.createElement("div");
    div.textContent = `ç¬¬${p.index}å•ï¼š ${p.result}`;
    answerList.appendChild(div);
  }
}

// ãƒˆã‚°ãƒ«è¡¨ç¤º
toggleAnswerBtn.onclick = () => {
  const box = answerContainer;
  if (box.style.display === "none"){
    box.style.display = "block";
    toggleAnswerBtn.textContent = "ğŸ”¼ ç­”ãˆã‚’éš ã™";
  } else {
    box.style.display = "none";
    toggleAnswerBtn.textContent = "ğŸ”½ ç­”ãˆã‚’è¡¨ç¤º";
  }
};

/************************************************************
 *  æ¼¢æ•°å­—åŒ– ï¼† ä¸‡ãƒ»å„„ãƒ»å…†ãƒãƒ¼ã‚º
 ************************************************************/
function toKanjiNumber(num){
  const small=['','å','ç™¾','åƒ'];
  const big=['','ä¸‡','å„„','å…†','äº¬'];
  const digits=['é›¶','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','ä¸ƒ','å…«','ä¹'];
  if(num===0) return 'é›¶';

  let s=String(num);
  const groups=[];
  while(s.length>0){
    groups.unshift(s.slice(-4));
    s=s.slice(0,-4);
  }

  let out='';
  groups.forEach((grp,gi)=>{
    let part='';
    const g=grp.padStart(4,'0').split('').map(n=>parseInt(n));
    for(let i=0;i<4;i++){
      const d=g[i]; if(d===0) continue;
      if(i===0 && d===1) part+=small[3];
      else if(i===1 && d===1) part+=small[2];
      else if(i===2 && d===1) part+=small[1];
      else part+=digits[d]+small[3-i];
    }
    if(part) part+=big[groups.length-gi-1];
    out+=part;
  });
  return out || 'é›¶';
}

function splitKanjiByBigUnits(kanjiStr){
  const units=['å…†','å„„','ä¸‡'];
  const parts=[]; let buf='';
  for(let i=0;i<kanjiStr.length;i++){
    buf += kanjiStr[i];
    if(units.includes(kanjiStr[i])){ parts.push(buf); buf=''; }
  }
  if(buf) parts.push(buf);
  return parts;
}

async function speakNumberWithUnitPauses(n,useKanji,tail,unitPauseMs=120){
  if(!useKanji){ await speak(String(n)+tail); return; }
  const k=toKanjiNumber(n);
  const parts=splitKanjiByBigUnits(k);
  if(parts.length<=1){ await speak(k+tail); return; }
  for(let i=0;i<parts.length;i++){
    const last=(i===parts.length-1);
    await speak(parts[i] + (last? tail:'' ));
    if(!last) await delay(unitPauseMs);
  }
}

/************************************************************
 *  å…ƒã‚¢ãƒ—ãƒªæº–æ‹ ï¼šç¬¦åˆèªãƒ»èªå°¾
 ************************************************************/
async function playProblem(p){
  const useK = (useKanji.value==="true");
  const stepMs = parseFloat(stepInterval.value)*1000;

  for(let i=0;i<p.steps.length;i++){
    const st=p.steps[i];
    const prev=i>0? p.steps[i-1]:null;
    const last=(i===p.steps.length-1);

    const needsPrefix = i>0 && ((prev.op==='+') !== (st.op==='+'));
    if(needsPrefix){
      await speak(st.op==='+'? "ãã‚ãˆã¦ ":"ã¨ã£ã¦ã‚ ");
    }

    const tail = last? "å††ã€ã§ã‚":"å††ãªã‚Šãƒ¼ã€";
    await speakNumberWithUnitPauses(st.value,useK,tail,100);

    if(!last) await delay(stepMs);
  }
}

/************************************************************
 *  æ“ä½œãƒœã‚¿ãƒ³
 ************************************************************/
startBtn.onclick = async () => {
  for(const p of problems){
    log(`ç¬¬${p.index}å•`);
    await speak(`ç¬¬${p.index}å•`);
    await playProblem(p);

    const wait = parseFloat(problemInterval.value);
    if(Number.isFinite(wait) && wait>0) await delay(wait*1000);
  }
  await speak("ä»¥ä¸Šã§å¾©ç¿’ã‚’çµ‚äº†ã—ã¾ã™ã€‚");
};

singleBtn.onclick = async () => {
  const n=parseInt(singleIndex.value);
  const p=problems.find(x=>x.index===n);
  if(!p){ alert("è©²å½“å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“"); return; }

  log(`å˜ä½“èª­ã¿ï¼šç¬¬${n}å•`);
  await speak(`ç¬¬${n}å•ã€å¾©ç¿’ã§ã™ã€‚`);
  await playProblem(p);
};
</script>
</body>
</html>
